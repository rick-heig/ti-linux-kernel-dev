From 703c80d07c44ce1ba81164b33d369d124c22f9a1 Mon Sep 17 00:00:00 2001
From: Nishanth Menon <nm@ti.com>
Date: Fri, 3 May 2024 18:15:31 -0500
Subject: [PATCH 16/16] HACK: drm/bridge: ite-it66121: Hack hpd back in

Commit 85e6b8d401de ("HACK: drm/bridge: ite-it66121: Add drm_connector
support") and related patches seem to have broken HPD. hack the same
in.

NOTE: This hack is not perfect, if the HDMI is not plugged in at the
very start of the boot, we seem to manually need to trigger the
following (path to display depends on platform and configuration)

echo connected|sudo tee /sys/class/drm/card0-HDMI-A-1/status

Signed-off-by: Jared McArthur <j-mcarthur@ti.com>
Signed-off-by: Nishanth Menon <nm@ti.com>
---
 drivers/gpu/drm/bridge/ite-it66121.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/gpu/drm/bridge/ite-it66121.c b/drivers/gpu/drm/bridge/ite-it66121.c
index fe750756cbc3..8ff838afcfcc 100644
--- a/drivers/gpu/drm/bridge/ite-it66121.c
+++ b/drivers/gpu/drm/bridge/ite-it66121.c
@@ -648,6 +648,8 @@ static const struct drm_connector_funcs it66121_connector_funcs = {
 	.atomic_destroy_state = drm_atomic_helper_connector_destroy_state,
 };
 
+static void it66121_bridge_hpd_enable(struct drm_bridge *bridge);
+
 static int it66121_bridge_attach(struct drm_bridge *bridge,
 				 enum drm_bridge_attach_flags flags)
 {
@@ -730,6 +732,9 @@ static int it66121_bridge_attach(struct drm_bridge *bridge,
 	/* Per programming manual, sleep here for bridge to settle */
 	msleep(50);
 
+	/* HACK For some part of missing hotplug somewhere.. */
+	it66121_bridge_hpd_enable(bridge);
+
 	return 0;
 }
 
-- 
2.39.2

